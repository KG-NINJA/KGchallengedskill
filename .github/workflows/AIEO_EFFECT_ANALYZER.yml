name: AIEO Effect Analyzer ğŸ“ˆ

# ç›®çš„:
# - Visibility Pulse (ãƒˆãƒ©ãƒƒã‚«ãƒ¼) ã®å®Ÿè¡Œå®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ã€åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã€‚
# - è¤‡æ•°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã€è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (Composite Index) ã‚’è¨ˆç®—ãƒ»å¯è¦–åŒ–ã™ã‚‹ã€‚

# ä¿®æ­£ç‚¹: 'disabled: true' ã‚’å‰Šé™¤ã—ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚

on:
  # 'AIEO Multi-Keyword Visibility Pulse' ãŒå®Œäº†ã—ãŸã¨ãã«èµ·å‹•
  workflow_run:
    workflows: ["AIEO Multi-Keyword Visibility Pulse"]
    types: [completed]

concurrency:
  group: aieo_pipeline
  cancel-in-progress: true

jobs:
  analyze:
    # Visibility Pulse ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Artifacts (Visibility Logs)
        uses: actions/github-script@v6
        with:
          script: |
            # æˆåŠŸã—ãŸVisibility Pulseã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒIDã‚’å–å¾—
            const runId = context.payload.workflow_run.id;
            
            // Artifacts APIã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            // Artifactsã¯Visibility Pulseã§ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ã‚¹ã‚­ãƒƒãƒ—ã¾ãŸã¯ã€
            // å¿…è¦ã«å¿œã˜ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºä¿ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
            
            // ä¾‹: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒArtifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            // const matchArtifact = artifacts.data.artifacts.find(artifact => artifact.name == "visibility-data");
            // if (matchArtifact) {
            //   const download = await github.rest.actions.downloadArtifact({
            //     owner: context.repo.owner,
            //     repo: context.repo.repo,
            //     artifact_id: matchArtifact.id,
            //     archive_format: 'zip',
            //   });
            //   const fs = require('fs');
            //   fs.writeFileSync('visibility-data.zip', Buffer.from(download.data));
            //   // unzip and process
            // }


      - name: Install dependencies
        run: pip install pandas matplotlib

      - name: Run composite index generator
        # scripts/aieo_composite_tracker.py ã‚’å®Ÿè¡Œã—ã€åˆ†æã‚’é–‹å§‹
        run: python scripts/aieo_composite_tracker.py

      - name: Commit & Push composite index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add aieo_composite_chart.png aieo_composite_log.csv
          # å¤‰æ›´ãŒãªã„å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ã‚¸ãƒ§ãƒ–å…¨ä½“ã¯æˆåŠŸã¨ã™ã‚‹
          git commit -m "ğŸ” Updated AIEO Composite Index" || exit 0
          git push
