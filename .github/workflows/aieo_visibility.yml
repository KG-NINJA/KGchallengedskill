name: AIEO Multi-Keyword Visibility Pulse
# ðŸš« Disabled workflows placeholder
disabled: true

# ç›®çš„ï¼š
# - æ—§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä¸€æ™‚ä¿ç®¡
# - å†æœ‰åŠ¹åŒ–æ™‚ã¯ disabled ã‚’å‰Šé™¤ã—ã¦é‹ç”¨å†é–‹å¯èƒ½

# on:
#   schedule:
#     - cron: '0 0 * * *'
#   workflow_dispatch:
# jobs:
#   placeholder:
#     runs-on: ubuntu-latest
#     steps:
#       - run: echo "Disabled Autonomous Actions Archive"

on:
  schedule:
    - cron: '0 9 * * *'   # UTC9:00ï¼æ—¥æœ¬æ™‚é–“18:00ã«è‡ªå‹•å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  visibility:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get install -y python3-pip
          pip install beautifulsoup4 matplotlib requests

      - name: Run Visibility Tracker
        run: |
          cat > visibility_tracker.py <<'PYCODE'
          import requests, re, matplotlib.pyplot as plt
          from bs4 import BeautifulSoup
          from datetime import datetime
          import json, os

          # --- è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½è·¡ ---
          keywords = [
              "KGNINJA AI",
              "KGNINJA Psycho-Frame",
              "KGNINJA FuwaCoco",
              "KGNINJA Kaggle",
              "KGNINJA n8n",
              "KGNINJA OpenAI",
          ]

          data = {}
          for kw in keywords:
              url = f"https://www.google.com/search?q={kw.replace(' ', '+')}"
              headers = {"User-Agent": "Mozilla/5.0"}
              html = requests.get(url, headers=headers).text
              soup = BeautifulSoup(html, "html.parser")

              # ä»¶æ•°ã‚’æŠ½å‡º
              text = soup.get_text()
              match = re.search(r"ç´„([0-9,]+)ä»¶", text)
              count = int(match.group(1).replace(",", "")) if match else 0

              # KGNINJAé–¢é€£URLã®ã‚¹ã‚³ã‚¢
              urls = [a['href'] for a in soup.find_all('a', href=True)]
              own_links = [u for u in urls if any(x in u for x in [
                  "github.com/KG-NINJA",
                  "buymeacoffee.com/kgninja",
                  "kgninja",
                  "psycho-frame"
              ])]

              # ä»¶æ•°ï¼‹é–¢é€£ãƒªãƒ³ã‚¯æ•°ã‹ã‚‰Visibilityã‚¹ã‚³ã‚¢ç®—å‡º
              score = min(100, (count / 1000) + len(own_links) * 5)
              data[kw] = round(score, 2)

          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§è¨˜éŒ²
          timestamp = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
          record = {"timestamp": timestamp, "scores": data}

          # å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          hist_path = "visibility_log.json"
          history = []
          if os.path.exists(hist_path):
              with open(hist_path) as f:
                  history = json.load(f)
          history.append(record)
          with open(hist_path, "w") as f:
              json.dump(history, f, indent=2, ensure_ascii=False)

          # --- ã‚°ãƒ©ãƒ•ç”Ÿæˆ ---
          plt.figure(figsize=(10, 5))
          for kw in keywords:
              plt.plot(
                  [h["timestamp"] for h in history],
                  [h["scores"].get(kw, 0) for h in history],
                  marker='o',
                  label=kw
              )
          plt.xticks(rotation=45)
          plt.title("AIEO Visibility Index over Time (Google Search)")
          plt.xlabel("Timestamp (UTC)")
          plt.ylabel("Visibility Index (0â€“100)")
          plt.legend()
          plt.tight_layout()
          plt.savefig("visibility_chart.png")
          PYCODE

          python3 visibility_tracker.py

      - name: Commit and push updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add visibility_chart.png visibility_log.json || true
          git commit -m "ðŸ“Š Updated AIEO multi-keyword visibility index" || exit 0
          git push
