name: ðŸŒ AIEO Visibility Tracker (Google Custom Search API)
# ðŸš« Disabled workflows placeholder
disabled: true

# ç›®çš„ï¼š
# - æ—§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä¸€æ™‚ä¿ç®¡
# - å†æœ‰åŠ¹åŒ–æ™‚ã¯ disabled ã‚’å‰Šé™¤ã—ã¦é‹ç”¨å†é–‹å¯èƒ½

# on:
#   schedule:
#     - cron: '0 0 * * *'
#   workflow_dispatch:
# jobs:
#   placeholder:
#     runs-on: ubuntu-latest
#     steps:
#       - run: echo "Disabled Autonomous Actions Archive"

on:
  schedule:
    - cron: '30 9 * * *'  # UTC9:30 = æ—¥æœ¬æ™‚é–“18:30ã«è‡ªå‹•å®Ÿè¡Œ
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯

jobs:
  visibility:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install google-api-python-client matplotlib

      - name: Run Visibility Tracker (Google API)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_CX: ${{ secrets.GOOGLE_CX }}
        run: |
          cat > visibility_tracker.py <<'PYCODE'
          from googleapiclient.discovery import build
          from datetime import datetime
          import json, os, matplotlib.pyplot as plt

          # --- AIEO ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¾¤ï¼ˆã“ã“ã‚’è‡ªç”±ã«è¿½åŠ ï¼‰ ---
          keywords = [
              "KGNINJA AI", "KGNINJA Psycho-Frame", "KGNINJA FuwaCoco",
              "KGNINJA Kaggle", "KGNINJA n8n", "KGNINJA OpenAI"
          ]

          # --- Google Custom Search API ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
          service = build("customsearch", "v1", developerKey=os.environ["GOOGLE_API_KEY"])
          cx = os.environ["GOOGLE_CX"]

          # --- ãƒ‡ãƒ¼ã‚¿å–å¾— ---
          data = {}
          for kw in keywords:
              try:
                  res = service.cse().list(q=kw, cx=cx).execute()
                  total = int(res["searchInformation"]["totalResults"])
                  # æ­£è¦åŒ–ã‚¹ã‚³ã‚¢ï¼ˆæœ€å¤§10ä¸‡ä»¶â†’100ã‚¹ã‚³ã‚¢ï¼‰
                  score = min(100, total / 1000)
                  data[kw] = round(score, 2)
              except Exception as e:
                  data[kw] = 0
                  print(f"âš ï¸ {kw} failed: {e}")

          # --- ãƒ­ã‚°ä¿å­˜ ---
          timestamp = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
          record = {"timestamp": timestamp, "scores": data}

          hist_path = "visibility_log.json"
          history = []
          if os.path.exists(hist_path):
              with open(hist_path) as f:
                  history = json.load(f)
          history.append(record)
          with open(hist_path, "w") as f:
              json.dump(history, f, indent=2, ensure_ascii=False)

          # --- å¯è¦–åŒ–ã‚°ãƒ©ãƒ•ä½œæˆ ---
          plt.figure(figsize=(10, 5))
          for kw in keywords:
              plt.plot([h["timestamp"] for h in history],
                      [h["scores"].get(kw, 0) for h in history],
                      marker='o', label=kw)
          plt.xticks(rotation=45)
          plt.title("AIEO Visibility Index (Google Custom Search API)")
          plt.xlabel("Timestamp (UTC)")
          plt.ylabel("Visibility Index (0â€“100)")
          plt.legend()
          plt.tight_layout()
          plt.savefig("visibility_chart.png")
          PYCODE

          python3 visibility_tracker.py

      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add visibility_chart.png visibility_log.json
          git commit -m "ðŸ“Š Updated AIEO Visibility Index via Google API" || echo "No changes to commit"
          git push
